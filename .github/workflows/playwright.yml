name: Playwright Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: lts/*

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: ðŸ§ª Run Playwright tests
        id: run-tests
        run: |
          set +e
          npx playwright test --reporter=html
          echo "TESTS_EXIT_CODE=$?" >> $GITHUB_ENV
          set -e

      # === 1ï¸âƒ£ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ ÐºÐ°Ðº Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ ===
      - name: ðŸ“ Upload Playwright HTML Report
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 3

      # === 2ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ dashboard (ÐºÐ¾Ñ€Ð½ÐµÐ²ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ) ===
      - name: ðŸª„ Create Dashboard index.html
        run: |
          mkdir -p site
          REPO="${{ github.repository }}"
          REPORT_URL="https://${REPO%%/*}.github.io/${REPO#*/}/report/"
          LAST_RUN="$(date -u +"%Y-%m-%d %H:%M UTC")"

          if [ "${TESTS_EXIT_CODE}" != "0" ]; then
            STATUS="âŒ Failed"
            COLOR="#dc3545"
          else
            STATUS="âœ… Passed"
            COLOR="#28a745"
          fi

          cat > site/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Playwright Test Dashboard</title>
            <style>
              body { font-family: system-ui, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #f6f8fa; color: #24292f; }
              h1 { font-size: 2rem; margin-bottom: 0.5rem; }
              p { font-size: 1rem; margin: 0.3rem 0; }
              a { display: inline-block; margin-top: 20px; padding: 12px 20px; background: ${COLOR}; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; }
              a:hover { opacity: 0.9; }
              footer { margin-top: 2rem; font-size: 0.85rem; color: #6a737d; }
            </style>
          </head>
          <body>
            <h1>ðŸš€ Playwright Tests</h1>
            <p><strong>Status:</strong> ${STATUS}</p>
            <p><strong>Last run:</strong> ${LAST_RUN}</p>
            <a href="./report/">View Full HTML Report</a>
            <footer>ðŸ“¦ Repo: ${REPO}</footer>
          </body>
          </html>
          EOF

      # === 3ï¸âƒ£ ÐŸÐµÑ€ÐµÐ½Ð¾ÑÐ¸Ð¼ HTML-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð² Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÑƒ ===
      - name: ðŸ“‚ Move Playwright report into site/report
        run: |
          mkdir -p site/report
          cp -r playwright-report/* site/report/

      # === 4ï¸âƒ£ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð° Ð¸ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð° ===
      - name: ðŸš€ Deploy dashboard and report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4 # âœ… v4 â€” Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑÑ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: site
          force_orphan: true
          commit_message: "Deploy Playwright Dashboard + Report ðŸš€"

      # === 5ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ ===
      - name: âœ… Verify GitHub Pages deployment
        run: |
          REPO="${{ github.repository }}"
          PAGE_URL="https://${REPO%%/*}.github.io/${REPO#*/}/"
          echo "ðŸ” Checking availability of $PAGE_URL ..."

          for i in {1..10}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$PAGE_URL" || true)
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Page is live: $PAGE_URL"
              exit 0
            fi
            echo "â³ Attempt $i/10 â€” Page not live yet (HTTP $STATUS)"
            sleep 10
          done

          echo "âŒ Page did not become available in time: $PAGE_URL"
          exit 1

      # === 6ï¸âƒ£ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ URL ===
      - name: ðŸŒ Prepare report URL
        run: |
          REPO="${{ github.repository }}"
          REPORT_URL="https://${REPO%%/*}.github.io/${REPO#*/}/"
          echo "REPORT_URL=$REPORT_URL" >> $GITHUB_ENV
          echo "âœ… Report available at: $REPORT_URL"
