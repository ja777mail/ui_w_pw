name: Playwright Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üé≠ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: üß™ Run Playwright tests
        id: run-tests
        run: |
          set +e
          npx playwright test --reporter=html
          echo "TESTS_EXIT_CODE=$?" >> $GITHUB_ENV
          set -e

      # === 1Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á—ë—Ç –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç ===
      - name: üìÅ Upload Playwright HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 3

      # === 2Ô∏è‚É£ –°–æ–∑–¥–∞—ë–º dashboard (–∫–æ—Ä–Ω–µ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É) ===
      - name: ü™Ñ Create Dashboard index.html
        run: |
          mkdir -p site
          REPO="${{ github.repository }}"
          REPORT_URL="https://${REPO%%/*}.github.io/${REPO#*/}/report/"
          LAST_RUN="$(date -u +"%Y-%m-%d %H:%M UTC")"

          if [ "${TESTS_EXIT_CODE}" != "0" ]; then
            STATUS="‚ùå Failed"
            COLOR="#dc3545"
          else
            STATUS="‚úÖ Passed"
            COLOR="#28a745"
          fi

          cat > site/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Playwright Test Dashboard</title>
            <style>
              body { font-family: system-ui, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #f6f8fa; color: #24292f; }
              h1 { font-size: 2rem; margin-bottom: 0.5rem; }
              p { font-size: 1rem; margin: 0.3rem 0; }
              a { display: inline-block; margin-top: 20px; padding: 12px 20px; background: ${COLOR}; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; }
              a:hover { opacity: 0.9; }
              footer { margin-top: 2rem; font-size: 0.85rem; color: #6a737d; }
            </style>
          </head>
          <body>
            <h1>üöÄ Playwright Tests</h1>
            <p><strong>Status:</strong> ${STATUS}</p>
            <p><strong>Last run:</strong> ${LAST_RUN}</p>
            <a href="./report/">View Full HTML Report</a>
            <footer>üì¶ Repo: ${REPO}</footer>
          </body>
          </html>
          EOF

      # === 3Ô∏è‚É£ –ü–µ—Ä–µ–Ω–æ—Å–∏–º HTML-–æ—Ç—á—ë—Ç –≤ –ø–æ–¥–ø–∞–ø–∫—É ===
      - name: üìÇ Move Playwright report into site/report
        run: |
          mkdir -p site/report
          cp -r playwright-report/* site/report/

      # === 4Ô∏è‚É£ –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages ===
      - name: üöÄ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: site
          force_orphan: true
          commit_message: "Deploy Playwright Dashboard + Report üöÄ"

      # === 5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
      - name: ‚úÖ Verify GitHub Pages deployment
        run: |
          REPO="${{ github.repository }}"
          PAGE_URL="https://${REPO%%/*}.github.io/${REPO#*/}/"
          echo "üîç Checking availability of $PAGE_URL ..."

          for i in {1..10}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$PAGE_URL" || true)
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Page is live: $PAGE_URL"
              exit 0
            fi
            echo "‚è≥ Attempt $i/10 ‚Äî Page not live yet (HTTP $STATUS)"
            sleep 10
          done

          echo "‚ùå Page did not become available in time: $PAGE_URL"
          exit 1

      # === 6Ô∏è‚É£ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ workflow-–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã ===
      - name: üßπ Clean up old workflow artifacts
        uses: actions/delete-artifact@v4
        with:
          name: playwright-report
          failOnError: false

      # === 7Ô∏è‚É£ –ü–µ—á–∞—Ç–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π URL ===
      - name: üåê Print report URL
        run: |
          REPO="${{ github.repository }}"
          REPORT_URL="https://${REPO%%/*}.github.io/${REPO#*/}/"
          echo "‚úÖ Report available at: $REPORT_URL"
